<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Faltantes de Locales</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#202124; --card:#2e2f31; --border:#3c3d3f; --text:#e8eaed; --muted:#9aa0a6; --primary:#10a37f; --primary2:#4a90e2; --danger:#d93f3f; --warn:#f9ab00;
    }
    *{box-sizing:border-box}
    body{font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:20px;background:var(--bg);color:var(--text)}
    .main-title{font-size:2rem;text-align:center;margin:0 0 20px;background:linear-gradient(90deg,var(--primary2),var(--primary));-webkit-background-clip:text;-webkit-text-fill-color:transparent;font-weight:600}
    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:20px;box-shadow:0 8px 30px rgba(0,0,0,.35)}
    #login{max-width:360px;margin:40px auto}
    input,button,select{padding:10px;border-radius:8px;border:1px solid var(--border);background:var(--card);color:var(--text)}
    input::placeholder{color:var(--muted)}
    input:focus,select:focus{outline:none;border-color:var(--primary2)}
    .btn{cursor:pointer;border:none;transition:transform .06s,filter .2s}
    .btn:active{transform:translateY(1px) scale(.99)}
    .btn-primary{background:var(--primary);color:#101315}
    .btn-primary:hover{filter:brightness(1.05)}
    .btn-warn{background:var(--warn);color:#202124}
    .btn-danger{background:var(--danger);color:#fff;border:none;padding:4px 8px}
    .topbar{display:flex;gap:10px;align-items:center;justify-content:space-between;margin-bottom:12px}
    .muted{color:var(--muted);font-size:.95rem}
    .stores{display:grid;gap:16px;margin-top:16px}
    @media(min-width:900px){.stores{grid-template-columns:repeat(2,minmax(0,1fr))}}
    .store{border-radius:12px;border:1px solid var(--border);padding:16px;background:var(--card);transition:transform .15s}
    .store:hover{transform:translateY(-3px)}
    .store h2{margin:0 0 12px;font-size:1.25rem}
    .item-input{display:flex;gap:8px;margin-bottom:10px}
    .item-input input{flex:1}
    ul{margin:0;padding-left:18px}
    li{margin:6px 0}
    .hidden{display:none!important}
  </style>
  <!-- Firebase SDK (solo App + Realtime DB, sin Auth) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
</head>
<body>
  <!-- LOGIN SIMPLE (dropdown) -->
  <section id="login" class="card">
    <h1 class="main-title">Faltantes de Locales</h1>
    <div style="display:grid;gap:10px">
      <select id="username">
        <option value="">-- Elige usuario --</option>
        <option value="admin">Administrador</option>
        <option value="aguila">Águila</option>
        <option value="66">66</option>
        <option value="parque">Parque</option>
        <option value="market">Market</option>
        <option value="multi">Multi</option>
      </select>
      <input type="password" id="password" placeholder="Contraseña (solo admin)" class="hidden" />
      <button id="login-btn" class="btn btn-primary">Entrar</button>
    </div>
  </section>

  <!-- APP -->
  <section id="app" class="hidden">
    <div class="topbar">
      <h1 class="main-title" style="margin:0">Faltantes de Locales</h1>
      <div>
        <span class="muted">Usuario: <span id="who"></span> · <span id="role"></span></span>
        <button id="logout" class="btn btn-warn" style="margin-left:10px">Cambiar usuario</button>
      </div>
    </div>

    <div id="stores" class="stores">
      <div class="store" id="store1">
        <h2>Águila</h2>
        <div class="item-input">
          <input type="text" id="store1-input" placeholder="Artículo faltante" />
          <button class="btn btn-primary" onclick="addItem('store1')">Agregar</button>
        </div>
        <ul id="store1-list"></ul>
      </div>

      <div class="store" id="store2">
        <h2>66</h2>
        <div class="item-input">
          <input type="text" id="store2-input" placeholder="Artículo faltante" />
          <button class="btn btn-primary" onclick="addItem('store2')">Agregar</button>
        </div>
        <ul id="store2-list"></ul>
      </div>

      <div class="store" id="store3">
        <h2>Parque</h2>
        <div class="item-input">
          <input type="text" id="store3-input" placeholder="Artículo faltante" />
          <button class="btn btn-primary" onclick="addItem('store3')">Agregar</button>
        </div>
        <ul id="store3-list"></ul>
      </div>

      <div class="store" id="store4">
        <h2>Market</h2>
        <div class="item-input">
          <input type="text" id="store4-input" placeholder="Artículo faltante" />
          <button class="btn btn-primary" onclick="addItem('store4')">Agregar</button>
        </div>
        <ul id="store4-list"></ul>
      </div>

      <div class="store" id="store5">
        <h2>Multi</h2>
        <div class="item-input">
          <input type="text" id="store5-input" placeholder="Artículo faltante" />
          <button class="btn btn-primary" onclick="addItem('store5')">Agregar</button>
        </div>
        <ul id="store5-list"></ul>
      </div>
    </div>
  </section>

  <script>
    // --- Firebase (SIN seguridad / sin Auth) ---
    const firebaseConfig = {
      apiKey: "AIzaSyDeBrwv8M3cm5KPvH61KQgdG6-I-PqQmoU",
      authDomain: "faltanteslocales.firebaseapp.com",
      databaseURL: "https://faltanteslocales-default-rtdb.firebaseio.com",
      projectId: "faltanteslocales",
      storageBucket: "faltanteslocales.firebasestorage.app",
      messagingSenderId: "174313821134",
      appId: "1:174313821134:web:d29668633425db7b00119f"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // Estado simple
    let currentUser = '';
    let isAdmin = false;
    let allowedStores = [];

    const storeMap = { aguila:['store1'], '66':['store2'], parque:['store3'], market:['store4'], multi:['store5'] };
    const displayMap = { admin:'Administrador', aguila:'Águila', '66':'66', parque:'Parque', market:'Market', multi:'Multi' };
    const storeLabels = { store1:'Águila', store2:'66', store3:'Parque', store4:'Market', store5:'Multi' };

    // Utilidades
    const $ = (s) => document.querySelector(s);
    function show(idSel){ $(idSel).classList.remove('hidden'); }
    function hide(idSel){ $(idSel).classList.add('hidden'); }

    // Listeners DB por tienda
    const listeners = {}; // { storeId: [{ref, ev, fn}, ...] }
    function detachAll(){
      Object.values(listeners).forEach(arr => arr.forEach(({ref,ev,fn}) => ref.off(ev, fn)));
      Object.keys(listeners).forEach(k => delete listeners[k]);
    }

    function initListeners(){
      detachAll();
      // Limpia listas visibles
      Object.keys(storeLabels).forEach(id => { const ul = document.getElementById(id+'-list'); if (ul) ul.innerHTML=''; });

      allowedStores.forEach(storeId => {
        const ref = db.ref('stores/'+storeId+'/items');
        listeners[storeId] = listeners[storeId] || [];
        const onAdd = ref.on('child_added', snap => addItemToList(storeId, snap.key, snap.val()));
        const onRem = ref.on('child_removed', snap => removeItemFromList(storeId, snap.key));
        listeners[storeId].push({ref,ev:'child_added',fn:onAdd},{ref,ev:'child_removed',fn:onRem});
      });

      // Enter para inputs
      Object.keys(storeLabels).forEach(storeId => {
        const inp = document.getElementById(storeId+'-input');
        if (!inp) return;
        inp.onkeydown = (e)=>{ if(e.key==='Enter') addItem(storeId); };
      });
    }

    // Acciones
    window.addItem = function(storeId){
      if (!allowedStores.includes(storeId)) return;
      const inp = document.getElementById(storeId+'-input');
      const text = (inp?.value||'').trim();
      if (!text) return;
      const item = { text, createdBy: displayMap[currentUser] || currentUser, ts: Date.now() };
      db.ref('stores/'+storeId+'/items').push(item);
      inp.value='';
    }

    function addItemToList(storeId, id, item){
      const ul = document.getElementById(storeId+'-list'); if(!ul) return;
      const li = document.createElement('li'); li.id = `${storeId}-${id}`;
      li.textContent = `${item.text} (por: ${item.createdBy || '—'})`;
      if (isAdmin){
        const btn = document.createElement('button'); btn.textContent='Eliminar'; btn.className='btn-danger'; btn.style.marginLeft='8px';
        btn.onclick = ()=>{ if(confirm('Eliminar este artículo?')) db.ref(`stores/${storeId}/items/${id}`).remove(); };
        li.appendChild(btn);
      }
      ul.appendChild(li);
    }
    function removeItemFromList(storeId, id){
      const li = document.getElementById(`${storeId}-${id}`); if(li) li.remove();
    }

    // Login simple (dropdown + contraseña solo admin)
    const userSel = document.getElementById('username');
    const passInp = document.getElementById('password');
    userSel.addEventListener('change', ()=>{ passInp.classList.toggle('hidden', userSel.value !== 'admin'); });

    function doLogin(){
      const u = (userSel.value||'').toLowerCase();
      if (!u) return alert('Seleccione un usuario');
      if (u === 'admin'){
        if (passInp.value !== 'admin') return alert('Contraseña incorrecta');
        isAdmin = true; allowedStores = Object.keys(storeLabels);
      } else if (storeMap[u]){
        isAdmin = false; allowedStores = storeMap[u];
      } else { return alert('Usuario no autorizado'); }

      currentUser = u;
      $('#who').textContent = displayMap[u];
      $('#role').textContent = isAdmin ? 'Administrador' : 'Empleado';
      hide('#login'); show('#app');

      // Mostrar solo tiendas permitidas
      Object.keys(storeLabels).forEach(id => {
        const el = document.getElementById(id);
        if (el) el.style.display = allowedStores.includes(id) ? 'block' : 'none';
      });

      initListeners();
    }

    document.getElementById('login-btn').addEventListener('click', doLogin);
    userSel.addEventListener('keydown', e=>{ if(e.key==='Enter') doLogin(); });
    passInp.addEventListener('keydown', e=>{ if(e.key==='Enter') doLogin(); });

    document.getElementById('logout').addEventListener('click', ()=>{
      detachAll();
      show('#login'); hide('#app');
      userSel.value=''; passInp.value=''; passInp.classList.add('hidden');
      // Reset visibles para próximo login
      Object.keys(storeLabels).forEach(id => { const el = document.getElementById(id); if(el) el.style.display='block'; const ul=document.getElementById(id+'-list'); if(ul) ul.innerHTML=''; });
    });
  </script>
</body>
</html>
